<html lang="id" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Donasi Mushola Al-Hidayah</title>
    <link rel="icon" type="image/svg+xml" href="asset/icon.svg" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="asset/chart.umd.js"></script>
    <script src="asset/sweetalert.js"></script>

    <link rel="stylesheet" type="text/css" href="asset/tailwind.css" />
    <style>
      #map {
        height: 400px;
        width: 100%;
        border-radius: 1.5rem;
      }
      .custom-scrollbar::-webkit-scrollbar {
        height: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
      }
      [v-cloak] {
        display: none;
      }
      .card-glow {
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 font-sans">
    <nav
      class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200"
    >
      <div
        class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <h1 class="text-2xl font-bold text-emerald-600 tracking-tight">
          Al-Hidayah
        </h1>

        <div class="hidden md:flex space-x-6 items-center">
          <a
            href="#keutamaan"
            class="hover:text-emerald-600 transition font-medium"
            >Keutamaan</a
          >
          <a
            href="#progres"
            class="hover:text-emerald-600 transition font-medium"
            >Progres</a
          >
          <a
            href="#transaksi"
            class="hover:text-emerald-600 transition font-medium"
            >Laporan</a
          >
          <a
            href="#donasi"
            class="bg-emerald-600 text-white px-5 py-2 rounded-full hover:bg-emerald-700 transition font-bold shadow-lg shadow-emerald-100"
            >Donasi Sekarang</a
          >
        </div>

        <div class="md:hidden flex items-center">
          <button
            id="menu-btn"
            class="text-slate-600 hover:text-emerald-600 focus:outline-none"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div
        id="mobile-menu"
        class="hidden md:hidden bg-white border-t border-slate-100 px-4 py-4 space-y-4 shadow-xl"
      >
        <a
          href="#keutamaan"
          class="block text-slate-700 hover:text-emerald-600 font-medium py-2"
          >Keutamaan</a
        >
        <a
          href="#progres"
          class="block text-slate-700 hover:text-emerald-600 font-medium py-2"
          >Progres</a
        >
        <a
          href="#transaksi"
          class="block text-slate-700 hover:text-emerald-600 font-medium py-2"
          >Laporan</a
        >
        <a
          href="#donasi"
          class="block bg-emerald-600 text-white px-5 py-3 rounded-xl hover:bg-emerald-700 transition font-bold text-center"
          >Donasi Sekarang</a
        >
      </div>
    </nav>

    <header
      class="py-12 md:py-16 px-4 text-center bg-gradient-to-b from-emerald-50 to-slate-50"
    >
      <div
        class="inline-block px-4 py-1.5 mb-6 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold uppercase tracking-widest"
      >
        Amalan Jariyah yang Tak Terputus
      </div>
      <h2
        class="text-3xl md:text-5xl font-extrabold mb-4 text-slate-900 leading-tight tracking-tight"
      >
        Pembangunan Mushola Al-Hidayah
      </h2>
      <p class="text-base md:text-lg text-slate-600 max-w-2xl mx-auto">
        Mari berinvestasi untuk akhirat dengan membantu mewujudkan rumah ibadah
        yang nyaman. Donasi Anda adalah saksi kebaikan di masa depan.
      </p>
    </header>

    <main class="max-w-6xl mx-auto px-4 space-y-12 md:space-y-20 pb-20">
      <section id="keutamaan" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div
          class="order-1 md:order-3 bg-white p-8 rounded-[2rem] border border-emerald-100 card-glow flex flex-col items-center text-center"
        >
          <div
            class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl mb-6"
          >
            <i class="fas fa-infinity"></i>
          </div>
          <h4 class="text-lg font-bold mb-3">Pahala Mengalir Terus</h4>
          <p class="text-sm text-slate-500 leading-relaxed">
            Membangun mushola adalah <b>Sedekah Jariyah</b>. Selama mushola
            digunakan untuk sujud, pahala akan terus mengalir kepada Anda meski
            raga telah tiada.
          </p>
        </div>

        <div
          class="order-2 md:order-1 bg-white p-8 rounded-[2rem] border border-rose-100 flex flex-col items-center text-center"
        >
          <div
            class="w-16 h-16 bg-rose-100 text-rose-600 rounded-2xl flex items-center justify-center text-2xl mb-6"
          >
            <i class="fas fa-hourglass-end"></i>
          </div>
          <h4 class="text-lg font-bold mb-3">Ruginya Melewatkan</h4>
          <p class="text-sm text-slate-500 leading-relaxed">
            Kesempatan beramal tidak datang dua kali. Melewatkan donasi berarti
            kehilangan peluang "investasi" dengan keuntungan abadi di saat harta
            dunia tak lagi berguna.
          </p>
        </div>

        <div
          class="order-3 md:order-2 bg-emerald-600 p-8 rounded-[2rem] text-white flex flex-col items-center text-center shadow-xl shadow-emerald-100"
        >
          <div
            class="w-16 h-16 bg-white/20 text-white rounded-2xl flex items-center justify-center text-2xl mb-6 border border-white/30"
          >
            <i class="fas fa-hand-holding-heart"></i>
          </div>
          <h4 class="text-lg font-bold mb-3">Mulai dari Rp 10.000</h4>
          <p class="text-sm text-emerald-50 leading-relaxed mb-4">
            Tak perlu menunggu kaya untuk berdonasi. Dengan
            <b>sepuluh ribu rupiah</b>, Anda sudah menyumbangkan satu bata untuk
            rumah Allah di dunia.
          </p>
          <a
            href="#donasi"
            class="bg-white text-emerald-600 px-6 py-2 rounded-xl text-xs font-bold hover:bg-emerald-50 transition"
            >Ikut Berdonasi</a
          >
        </div>
      </section>

      <section id="progres" class="space-y-8">
        <div class="text-center">
          <div
            class="inline-flex items-center justify-center w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl mb-4"
          >
            <i class="fas fa-hammer text-xl"></i>
          </div>
          <h3 class="text-3xl font-extrabold text-slate-900 tracking-tight">
            Target Pembangunan
          </h3>
          <p class="text-slate-500 mt-2">
            Laporan realisasi fisik dan target pengerjaan saat ini
          </p>
        </div>

        <div
          id="targetContainer"
          class="grid grid-cols-1 md:grid-cols-2 gap-6"
        ></div>
      </section>

      <section id="ringkasan-saldo" class="space-y-6">
        <div class="flex items-center gap-2">
          <i class="fas fa-wallet text-emerald-600 text-xl"></i>
          <h3 class="text-xl font-bold">Ringkasan Keuangan</h3>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div
            onclick="filterByCard('MASUK')"
            class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm group hover:border-emerald-200 transition cursor-pointer active:scale-95"
          >
            <p
              class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2"
            >
              Total Dana Masuk
            </p>
            <p id="totalMasuk" class="text-2xl font-bold text-emerald-600">
              Rp 0
            </p>
            <div
              class="mt-2 text-[10px] text-emerald-500 font-bold bg-emerald-50 inline-block px-2 py-0.5 rounded"
            >
              Klik untuk detail donasi
            </div>
          </div>

          <div
            onclick="filterByCard('KELUAR')"
            class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm group hover:border-rose-200 transition cursor-pointer active:scale-95"
          >
            <p
              class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2"
            >
              Total Dana Keluar
            </p>
            <p id="totalKeluar" class="text-2xl font-bold text-rose-600">
              Rp 0
            </p>
            <div
              class="mt-2 text-[10px] text-rose-500 font-bold bg-rose-50 inline-block px-2 py-0.5 rounded"
            >
              Klik untuk detail pengeluaran
            </div>
          </div>

          <div
            onclick="filterByCard('')"
            class="bg-emerald-600 p-6 rounded-3xl shadow-lg shadow-emerald-100 relative overflow-hidden group cursor-pointer active:scale-95"
          >
            <i
              class="fas fa-coins absolute -right-4 -bottom-4 text-emerald-500/20 text-8xl rotate-12 group-hover:scale-110 transition-transform"
            ></i>
            <p
              class="text-[10px] font-bold text-emerald-100 uppercase tracking-widest mb-2"
            >
              Saldo Saat Ini
            </p>
            <p
              id="totalSaldo"
              class="text-2xl font-bold text-white relative z-10"
            >
              Rp 0
            </p>
            <div
              class="mt-2 text-[10px] text-emerald-100 font-bold bg-white/20 inline-block px-2 py-0.5 rounded relative z-10"
            >
              Tampilkan Semua
            </div>
          </div>
        </div>
      </section>

      <section id="statistik" class="space-y-6">
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-4"
        >
          <h3 class="text-2xl font-bold flex items-center gap-2">
            <i class="fas fa-chart-line text-emerald-600"></i> Tren Keuangan
          </h3>
          <div class="inline-flex bg-slate-100 p-1 rounded-xl">
            <button
              onclick="updateChart('all')"
              id="btn-all"
              class="cursor-pointer chart-filter-btn px-4 py-1.5 rounded-lg text-xs font-bold transition bg-white shadow-sm text-emerald-600"
            >
              Semua
            </button>
            <button
              onclick="updateChart('yearly')"
              id="btn-yearly"
              class="cursor-pointer chart-filter-btn px-4 py-1.5 rounded-lg text-xs font-bold transition text-slate-500 hover:text-emerald-600"
            >
              Tahunan
            </button>
            <button
              onclick="updateChart('monthly')"
              id="btn-monthly"
              class="cursor-pointer chart-filter-btn px-4 py-1.5 rounded-lg text-xs font-bold transition text-slate-500 hover:text-emerald-600"
            >
              Bulanan
            </button>
            <button
              onclick="updateChart('weekly')"
              id="btn-weekly"
              class="cursor-pointer chart-filter-btn px-4 py-1.5 rounded-lg text-xs font-bold transition text-slate-500 hover:text-emerald-600"
            >
              Mingguan
            </button>
          </div>
        </div>
        <div
          class="bg-white p-4 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm"
        >
          <div class="overflow-x-auto custom-scrollbar">
            <div id="chartParent" style="min-width: 600px; height: 400px">
              <canvas id="financeChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="transaksi" class="space-y-6">
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-4"
        >
          <h3 class="text-2xl font-bold flex items-center gap-2">
            <i class="fas fa-exchange-alt text-emerald-600"></i> Catatan
            Penerimaan & Pengeluaran
          </h3>
          <div class="flex gap-2">
            <button
              onclick="toggleFilter()"
              class="cursor-pointer bg-white border border-slate-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-50 transition flex items-center gap-2"
            >
              <i class="fas fa-filter text-emerald-600"></i>
              Filter
            </button>
            <div class="relative">
              <i
                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"
              ></i>
              <input
                type="text"
                id="searchInput"
                onkeyup="filterData()"
                placeholder="Cari transaksi..."
                class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none w-full md:w-64"
              />
            </div>
          </div>
        </div>

        <div id="filterPanel" class="hidden">
          <div
            class="bg-white p-4 md:p-6 rounded-2xl border border-emerald-100 shadow-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"
          >
            <div class="space-y-1">
              <label
                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
                >Dari Tanggal</label
              >
              <input
                type="date"
                id="dateStart"
                class="cursor-pointer w-full border border-slate-100 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none"
              />
            </div>
            <div class="space-y-1">
              <label
                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
                >Hingga Tanggal</label
              >
              <input
                type="date"
                id="dateEnd"
                class="cursor-pointer w-full border border-slate-100 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none"
              />
            </div>
            <div class="space-y-1">
              <label
                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
                >Kategori</label
              >
              <select
                id="typeFilter"
                class="w-full border border-slate-100 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none"
              >
                <option value="">Semua Transaksi</option>
                <option value="MASUK">Masuk (Donasi Uang)</option>
                <option value="KELUAR">Keluar (Belanja)</option>
                <option value="NON_TUNAI">Non-Tunai (Barang/Jasa)</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button
                onclick="filterData()"
                class="cursor-pointer flex-1 bg-emerald-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition"
              >
                Terapkan
              </button>
              <button
                onclick="resetFilter()"
                class="cursor-pointer flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-sm font-bold hover:bg-slate-200 transition"
              >
                Reset
              </button>
            </div>
          </div>
        </div>

        <div
          id="filterSummary"
          class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"
        >
          <div
            class="bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-4"
          >
            <div
              class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center shrink-0"
            >
              <i class="fas fa-arrow-down text-xl"></i>
            </div>
            <div>
              <p
                class="text-[10px] uppercase font-bold text-slate-400 tracking-wider leading-none mb-1"
              >
                Total Pemasukan
              </p>
              <p id="filteredIn" class="text-xl font-bold text-slate-800">
                Rp 0
              </p>
            </div>
          </div>

          <div
            class="bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-4"
          >
            <div
              class="w-12 h-12 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center shrink-0"
            >
              <i class="fas fa-arrow-up text-xl"></i>
            </div>
            <div>
              <p
                class="text-[10px] uppercase font-bold text-slate-400 tracking-wider leading-none mb-1"
              >
                Total Pengeluaran
              </p>
              <p id="filteredOut" class="text-xl font-bold text-slate-800">
                Rp 0
              </p>
            </div>
          </div>
        </div>

        <div
          class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-slate-100 custom-scrollbar"
        >
          <table class="w-full text-left min-w-[700px]">
            <thead class="bg-slate-200/60 border-b border-slate-100">
              <tr>
                <th class="p-4 font-semibold text-slate-800 w-[15%]">
                  Tanggal
                </th>
                <th class="p-4 font-semibold text-slate-800">Keterangan</th>
                <th class="p-4 font-semibold text-slate-800 w-[12%]">Jenis</th>
                <th class="p-4 font-semibold text-right text-slate-800 w-[18%]">
                  Jumlah
                </th>
                <th class="p-4 font-semibold text-right text-slate-800 w-[18%]">
                  Saldo
                </th>
              </tr>
            </thead>
            <tbody
              id="transactionBody"
              class="divide-y divide-slate-200/60"
            ></tbody>
          </table>
        </div>

        <div
          class="flex flex-col md:flex-row items-center justify-between gap-4 px-2"
        >
          <p id="paginationInfo" class="text-sm text-slate-500 font-medium"></p>
          <div id="paginationButtons" class="flex gap-2"></div>
        </div>
      </section>

      <section id="arsip" class="space-y-6">
        <h3 class="text-2xl font-bold flex items-center gap-2">
          <i class="fas fa-file-excel text-emerald-600"></i> Arsip Data
          Transparan
        </h3>

        <div
          class="bg-emerald-50 border border-emerald-100 rounded-[2rem] p-6 flex flex-col md:flex-row items-center justify-between gap-6"
        >
          <div class="flex items-center gap-4">
            <div>
              <p
                class="text-slate-600 leading-relaxed max-w-xl text-sm md:text-base"
              >
                Setiap donasi adalah amanah yang kami pertanggungjawabkan
                melalui sistem pelaporan terbuka. Seluruh riwayat transaksi
                tercatat dan
                <span
                  class="text-emerald-700 font-bold underline decoration-emerald-200 decoration-4 underline-offset-2"
                  >dapat diakses publik</span
                >
                kapanpun dan dimanapun. Kami mengundang Anda untuk memantau atau
                mengaudit secara mandiri data yang kami sajikan sebagai wujud
                transparansi total kami.
              </p>
            </div>
          </div>
          <a
            id="sheetLink"
            href="https://docs.google.com/spreadsheets/d/1trIbNOsZplbzrXsXhp_uMho5eDeHtbQs_Q0TGck9Wjk/edit?gid=0#gid=0"
            target="_blank"
            class="w-full md:w-auto bg-white text-emerald-600 border border-emerald-200 px-6 py-3 rounded-xl text-sm font-bold hover:bg-emerald-600 hover:text-white transition flex items-center justify-center gap-2 shadow-sm"
          >
            <i class="fas fa-external-link-alt"></i> Buka Spreadsheet
          </a>
        </div>
      </section>

      <section class="space-y-6">
        <h3 class="text-2xl font-bold flex items-center gap-2">
          <i class="fas fa-map-marked-alt text-emerald-600"></i> Lokasi
          Pembangunan
        </h3>

        <div id="map" class="shadow-xl border-4 border-white mb-6"></div>

        <div
          class="shadow-xl border-4 border-white flex flex-col md:flex-row items-center justify-between gap-6 bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm"
        >
          <div class="flex items-start gap-4">
            <div
              class="w-12 h-12 bg-rose-50 text-rose-500 rounded-2xl flex items-center justify-center shrink-0"
            >
              <i class="fas fa-location-dot text-xl"></i>
            </div>
            <div>
              <p class="font-extrabold text-slate-800 text-lg">
                Musholas Al-Hidayah
              </p>
              <p class="text-slate-500 text-sm leading-relaxed">
                Jl. Sidoagung No.162, Candirenggo, <br />
                Kec. Singosari, Kabupaten Malang, Jawa Timur 65153
              </p>
            </div>
          </div>

          <a
            href="https://maps.app.goo.gl/3f8H3mF7n5v8G8A7"
            target="_blank"
            class="w-full md:w-auto bg-emerald-50 text-emerald-700 px-8 py-4 rounded-2xl text-sm font-black hover:bg-emerald-600 hover:text-white transition flex items-center justify-center gap-3 border border-emerald-100"
          >
            <i class="fas fa-directions"></i> BUKA DI GOOGLE MAPS
          </a>
        </div>
      </section>

      <section id="pengurus">
        <h3 class="text-2xl font-bold mb-8 text-center">Struktur Panitia</h3>
        <div
          id="panitiaContainer"
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6"
        ></div>
      </section>

      <section
        id="donasi"
        class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start"
      >
        <div
          class="bg-emerald-600 text-white p-8 md:p-10 rounded-[2.5rem] shadow-2xl shadow-emerald-200"
        >
          <h3 class="text-2xl font-bold mb-6">Saluran Donasi</h3>
          <div id="donasiContainer" class="space-y-6"></div>
          <div class="mt-8 pt-6 border-t border-white/10 text-center">
            <p class="text-sm italic text-emerald-100">
              "Satu bata dari Anda, satu rumah di surga dari Allah."
            </p>
          </div>
        </div>

        <div class="space-y-6 md:pt-6">
          <h3 class="text-2xl font-bold">Kontak Panitia</h3>
          <div id="kontakContainer" class="space-y-4"></div>
        </div>
      </section>
    </main>

    <footer class="bg-slate-900 text-slate-400 py-12 text-center px-4">
      <p class="mb-2 text-sm">Â© 2026 Panitia Pembangunan Mushola Al-Hidayah</p>
      <p class="text-xs italic opacity-60">
        "Siapa membangun tempat ibadah karena Allah, Allah bangunkan rumah di
        surga."
      </p>
    </footer>

    <script>
      // GANTI DENGAN URL WEB APP ANDA
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbwAt1e-yix4Yca9NTIQpyhr0I21Lq6AM3SwMnMNqVUfvP4MxqAlYgdit_SrTOViJi-XoQ/exec";

      let allTransactions = [];
      let filteredData = [];
      let currentPage = 1;
      const rowsPerPage = 8;
      let myChart = null;

      async function fetchData() {
        // Tampilkan Loading SweetAlert
        Swal.fire({
          title: "Memuat Data",
          html: "Mohon tunggu sebentar...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        try {
          const response = await fetch(WEB_APP_URL);
          const data = await response.json();

          // 1. Data Transaksi
          const rawLaporan = data["Laporan Keuangan"] || [];
          // Cari bagian ini di fungsi fetchData
          allTransactions = rawLaporan
            .map((item, index) => ({
              // Tambahkan index di sini
              date: item["Tanggal"] ? item["Tanggal"].split("T")[0] : "",
              note: item["Keterangan"] || "",
              type: (item["Jenis"] || "").toUpperCase(),
              amount: Number(item["Jumlah"]) || 0,
              unit: item["Satuan"] || "",
              originalIndex: index, // Simpan urutan asli dari Excel
            }))
            // Ubah logika sort di bawah ini
            .sort((a, b) => {
              const dateDiff = new Date(b.date) - new Date(a.date);
              if (dateDiff !== 0) return dateDiff;
              // Jika tanggal sama, gunakan indeks asli (angka lebih besar berarti baris lebih bawah di Excel)
              return b.originalIndex - a.originalIndex;
            });

          // 2. Target Pembangunan
          renderTargets(data["Target Pembangunan"] || []);

          // 3. Struktur Panitia
          renderPanitia(data["Struktur Panitia"] || []);

          // 4. Saluran Donasi
          renderSaluranDonasi(data["Saluran Donasi"], data["Kontak Panitia"]);

          // 5. Kontak Panitia
          renderKontakPanitia(data["Kontak Panitia"] || []);

          updateUI();

          // Tutup SweetAlert setelah data berhasil dimuat
          Swal.close();
        } catch (error) {
          console.error("Error fetching data:", error);

          // Tampilkan Error jika gagal
          Swal.fire({
            icon: "error",
            title: "Gagal Memuat Data",
            text: "Pastikan koneksi internet stabil dan Web App URL sudah benar.",
            confirmButtonColor: "#059669",
          });

          document.getElementById("transactionBody").innerHTML =
            '<tr><td colspan="4" class="p-10 text-center text-rose-500 font-bold">Gagal memuat data dari server.</td></tr>';
        }
      }

      function renderTargets(targets) {
        const container = document.getElementById("targetContainer");
        container.innerHTML = targets
          .map((t) => {
            const terkumpul = Number(t["Dana Terkumpul"]) || 0;
            const target = Number(t["Target Dana"]) || 1;
            const persen = Math.min(
              Math.round((terkumpul / target) * 100),
              100,
            );
            const isSelesai = t["Status"] === "Selesai";

            // Mengambil data keterangan dari server secara dinamis
            // Jika keterangan di sheet kosong, maka akan menampilkan persentase default
            const infoProgres = t["Keterangan"]
              ? t["Keterangan"]
              : `*Progres: ${persen}% Terkumpul`;

            return `
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border ${isSelesai ? "border-slate-100" : "border-emerald-200 ring-4 ring-emerald-50"} relative overflow-hidden">
              ${isSelesai ? '<div class="absolute top-0 right-0 bg-emerald-100 text-emerald-700 px-4 py-1 rounded-bl-xl text-xs font-bold uppercase">Selesai</div>' : ""}
              <h3 class="text-lg font-bold mb-1 ${!isSelesai ? "text-emerald-900" : ""}">${t["Nama Tahap"]}</h3>
              <div class="flex justify-between items-end mb-4">
                <span class="${isSelesai ? "text-2xl font-bold text-slate-400 line-through" : "text-3xl font-bold text-emerald-600"}">Rp ${terkumpul.toLocaleString("id-ID")}</span>
                ${!isSelesai ? `<span class="text-slate-400 text-sm font-medium">/ Rp ${target.toLocaleString("id-ID")}</span>` : ""}
              </div>
              <div class="w-full bg-slate-100 rounded-full h-4">
                <div class="bg-emerald-500 h-4 rounded-full transition-all duration-1000" style="width: ${persen}%"></div>
              </div>
              <p class="mt-4 text-xs text-slate-500 italic font-medium whitespace-pre-line">${infoProgres}</p>
            </div>
          `;
          })
          .join("");
      }

      function renderPanitia(panitia) {
        const container = document.getElementById("panitiaContainer");
        container.innerHTML = panitia
          .map(
            (p) => `
      <div class="bg-white p-6 rounded-3xl border border-slate-100 text-center shadow-sm hover:shadow-md transition">
        <div class="w-16 h-16 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-emerald-600 text-2xl font-bold">
          ${p["Nama"] ? p["Nama"].charAt(0) : "?"}
        </div>
        <h4 class="font-bold text-base leading-tight">${p["Nama"]}</h4>
        <p class="text-[10px] text-emerald-600 uppercase font-bold tracking-widest mt-1 mb-3">${p["Jabatan"]}</p>
        ${p["Tugas"] ? `<p class="text-xs text-slate-500 leading-relaxed border-t pt-3">${p["Tugas"]}</p>` : ""}
      </div>
    `,
          )
          .join("");
      }

      function renderSaluranDonasi(donasi = [], kontak = []) {
        const container = document.getElementById("donasiContainer");

        // 1. Bagian Rekening
        let html = donasi
          .map(
            (d) => `
        <div class="bg-white/10 p-5 rounded-2xl border border-white/20 mb-4 hover:bg-white/20 transition group">
            <p class="text-emerald-100 text-[10px] font-bold uppercase mb-2 tracking-widest">${d["Nama Bank"]}</p>
            <div class="flex justify-between items-center">
                <p class="text-2xl font-mono font-bold tracking-widest">${d["Nomor Rekening"]}</p>
                <button onclick="copyToClipboard('${d["Nomor Rekening"]}', 'Nomor rekening disalin!')" 
                        class="cursor-pointer text-emerald-300 hover:text-white transition p-2">
                    <i class="fas fa-copy text-lg"></i>
                </button>
            </div>
            <p class="text-sm mt-1 opacity-80 italic">${d["Atas Nama"]}</p>
        </div>
    `,
          )
          .join("");

        // 2. Bagian Konfirmasi Donasi
        const konfirmasi = kontak.filter(
          (k) => k["Kategori"] === "Konfirmasi Donasi",
        );
        if (konfirmasi.length > 0) {
          html += `
            <div class="mt-8 pt-6 border-t border-white/20">
                <h4 class="text-sm font-bold text-emerald-100 uppercase mb-4 text-center tracking-widest">Konfirmasi Donasi</h4>
                <div class="grid grid-cols-1 gap-3">
        `;

          html += konfirmasi
            .map((k) => {
              const cleanNum = k["Kontak"].toString().replace(/[^0-9]/g, "");
              const displayNum = formatPhoneNumber(cleanNum);
              return `
                <div class="group bg-white/10 border border-white/20 p-4 rounded-2xl transition-all flex items-center justify-between">
                    <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="window.open('https://wa.me/${cleanNum}')">
                        <div class="w-10 h-10 bg-emerald-400/20 group-hover:bg-emerald-400/40 rounded-full flex items-center justify-center transition">
                            <i class="${k["Icon (FontAwesome)"] || "fab fa-whatsapp"} text-emerald-300 group-hover:text-white text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-emerald-200 group-hover:text-white uppercase tracking-tighter">${k["Nama Kontak"]}</p>
                            <p class="text-sm font-mono text-white">${displayNum}</p>
                        </div>
                    </div>
                    <button onclick="copyToClipboard('${cleanNum}', 'Nomor WhatsApp disalin!')" 
                            class="cursor-pointer ml-2 text-emerald-300/50 hover:text-white transition p-2">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `;
            })
            .join("");
          html += `</div></div>`;
        }
        container.innerHTML = html;
      }

      function renderKontakPanitia(kontak = []) {
        const container = document.getElementById("kontakContainer");
        const panitiaHanya = kontak.filter(
          (k) => k["Kategori"] === "Kontak Panitia",
        );

        container.innerHTML = panitiaHanya
          .map((k) => {
            const cleanNum = k["Kontak"].toString().replace(/[^0-9]/g, "");
            const displayNum = formatPhoneNumber(cleanNum);
            return `
            <div class="group flex items-center gap-4 p-5 bg-white border border-slate-100 rounded-[2rem] shadow-sm hover:border-emerald-200 transition">
                <div class="flex-1 flex items-center gap-4 cursor-pointer" onclick="window.open('https://wa.me/${cleanNum}')">
                    <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center shrink-0 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                        <i class="${k["Icon (FontAwesome)"] || "fas fa-phone"} text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-slate-700 leading-tight tracking-widest">${k["Nama Kontak"]}</p>
                        <p class="text-lg font-bold text-emerald-600 font-mono mt-1">${displayNum}</p>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="copyToClipboard('${cleanNum}', 'Nomor telepon disalin!')" 
                            class="cursor-pointer p-2 text-slate-300 hover:text-emerald-600 transition" title="Salin Nomor">
                        <i class="fas fa-copy"></i>
                    </button>
                    <i class="fas fa-chevron-right text-slate-200 text-xs"></i>
                </div>
            </div>
        `;
          })
          .join("");
      }

      function updateUI() {
        calculateTotals();
        resetFilter();
      }

      function calculateTotals() {
        const inTotal = allTransactions
          .filter((t) => t.type === "MASUK")
          .reduce((a, b) => a + b.amount, 0);
        const outTotal = allTransactions
          .filter((t) => t.type === "KELUAR")
          .reduce((a, b) => a + b.amount, 0);
        document.getElementById("totalMasuk").innerText =
          `Rp ${inTotal.toLocaleString("id-ID")}`;
        document.getElementById("totalKeluar").innerText =
          `Rp ${outTotal.toLocaleString("id-ID")}`;
        document.getElementById("totalSaldo").innerText =
          `Rp ${(inTotal - outTotal).toLocaleString("id-ID")}`;
      }

      function updateChart(filter) {
        // 1. Perbarui tampilan tombol (UI)
        // Menghapus gaya aktif dari semua tombol filter grafik
        document.querySelectorAll(".chart-filter-btn").forEach((btn) => {
          btn.classList.remove("bg-white", "shadow-sm", "text-emerald-600");
          btn.classList.add("text-slate-500");
        });

        // Menambahkan gaya aktif ke tombol yang diklik
        const activeBtn = document.getElementById(`btn-${filter}`);
        if (activeBtn) {
          activeBtn.classList.remove("text-slate-500");
          activeBtn.classList.add("bg-white", "shadow-sm", "text-emerald-600");
        }

        // 2. Render ulang grafik dengan filter waktu yang dipilih
        // Fungsi initChart Anda akan menerima parameter 'all', 'yearly', 'monthly', atau 'weekly'
        if (typeof initChart === "function") {
          initChart(filter);
        }
      }

      function initChart(filter = "all") {
        const ctx = document.getElementById("financeChart").getContext("2d");
        const chartParent = document.getElementById("chartParent");
        const sortedData = [...allTransactions].sort(
          (a, b) => new Date(a.date) - new Date(b.date),
        );
        const groups = {};

        sortedData.forEach((t) => {
          let key = t.date;
          if (filter === "yearly") key = t.date.substring(0, 4);
          else if (filter === "monthly") key = t.date.substring(0, 7);
          if (!groups[key]) groups[key] = { masuk: 0, keluar: 0 };
          if (t.type === "MASUK") groups[key].masuk += t.amount;
          else if (t.type === "KELUAR") groups[key].keluar += t.amount;
        });

        const keys = Object.keys(groups);
        const labels = keys;
        const dataMasuk = keys.map((k) => groups[k].masuk);
        const dataKeluar = keys.map((k) => groups[k].keluar);

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Masuk",
                data: dataMasuk,
                borderColor: "#10b981",
                tension: 0.4,
              },
              {
                label: "Keluar",
                data: dataKeluar,
                borderColor: "#f43f5e",
                tension: 0.4,
              },
            ],
          },
          options: { maintainAspectRatio: false },
        });
      }

      function filterData() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const type = document.getElementById("typeFilter").value; // MASUK, KELUAR, atau ""
        const dateStart = document.getElementById("dateStart").value; // Format: YYYY-MM-DD
        const dateEnd = document.getElementById("dateEnd").value; // Format: YYYY-MM-DD

        filteredData = allTransactions.filter((item) => {
          // 1. Filter Berdasarkan Pencarian Teks
          const matchSearch = item.note.toLowerCase().includes(search);

          // 2. Filter Berdasarkan Jenis (Pemasukan/Pengeluaran)
          const matchType = type === "" || item.type === type;

          // 3. Filter Berdasarkan Rentang Tanggal
          let matchDate = true;
          if (dateStart || dateEnd) {
            const itemDate = new Date(item.date).getTime();
            const start = dateStart ? new Date(dateStart).getTime() : -Infinity;
            const end = dateEnd ? new Date(dateEnd).getTime() : Infinity;

            // Set end date ke akhir hari (23:59:59) agar tanggal akhir terhitung inklusif
            const adjustedEnd = dateEnd
              ? new Date(dateEnd).setHours(23, 59, 59, 999)
              : Infinity;

            matchDate = itemDate >= start && itemDate <= adjustedEnd;
          }

          return matchSearch && matchType && matchDate;
        });

        // Reset ke halaman 1 setiap kali filter berubah
        currentPage = 1;

        // Update Statistik Mini di atas tabel
        updateFilterSummary();

        // Render ulang tabel
        renderTable();
      }

      function renderTable() {
        const tbody = document.getElementById("transactionBody");

        // 1. Hitung Saldo Akumulatif untuk SEMUA data yang sudah difilter
        // Kita hitung dari data terlama (indeks terakhir) ke terbaru (indeks 0)
        let runningBalance = 0;

        // Buat array baru untuk menyimpan saldo setiap baris
        const dataWithBalance = [...filteredData]
          .reverse() // Balik dulu untuk hitung saldo dari awal waktu
          .map((item) => {
            if (item.type === "MASUK") {
              runningBalance += item.amount;
            } else if (item.type === "KELUAR") {
              runningBalance -= item.amount;
            }
            return { ...item, currentBalance: runningBalance };
          })
          .reverse(); // Balikkan lagi ke urutan terbaru di atas

        // 2. Lakukan Paginasi pada data yang sudah memiliki info saldo
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedItems = dataWithBalance.slice(
          start,
          start + rowsPerPage,
        );

        // 3. Render ke HTML
        tbody.innerHTML = paginatedItems
          .map(
            (item) => `
      <tr class="hover:bg-slate-50 transition border-b border-slate-100">
          <td class="p-4 text-xs font-medium text-slate-600 leading-relaxed">
              ${formatDate(item.date)}
          </td>
          <td class="p-4">
              <p class="font-bold text-slate-800">${item.note}</p>
          </td>
          <td class="p-4">
              <span class="px-2 py-1 rounded-full text-[10px] font-bold ${
                item.type.toLowerCase() === "masuk"
                  ? "bg-emerald-100 text-emerald-700"
                  : item.type.toLowerCase() === "keluar"
                    ? "bg-rose-100 text-rose-700"
                    : "bg-amber-100 text-amber-700"
              }">
                  ${item.type}
              </span>
          </td>
          <td class="p-4 text-right font-bold ${item.type === "MASUK" ? "text-emerald-600" : "text-rose-600"}">
              ${item.type === "KELUAR" ? "-" : ""}Rp ${Number(item.amount).toLocaleString("id-ID")}
          </td>
          <td class="p-4 text-right font-bold text-slate-900 bg-slate-50/50">
              Rp ${item.currentBalance.toLocaleString("id-ID")}
          </td>
      </tr>
    `,
          )
          .join("");

        updatePagination();
      }

      function updateFilterSummary() {
        const totalIn = filteredData
          .filter((t) => t.type === "MASUK")
          .reduce((sum, item) => sum + item.amount, 0);

        const totalOut = filteredData
          .filter((t) => t.type === "KELUAR")
          .reduce((sum, item) => sum + item.amount, 0);

        document.getElementById("filteredIn").innerText =
          `Rp ${totalIn.toLocaleString("id-ID")}`;
        document.getElementById("filteredOut").innerText =
          `Rp ${totalOut.toLocaleString("id-ID")}`;
      }

      function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        let btns = "";
        for (let i = 1; i <= totalPages; i++) {
          btns += `<button onclick="goToPage(${i})" class="cursor-pointer w-8 h-8 rounded ${i === currentPage ? "bg-emerald-600 text-white" : "border"}">${i}</button>`;
        }
        document.getElementById("paginationButtons").innerHTML = btns;
      }

      function goToPage(p) {
        currentPage = p;
        renderTable();
      }
      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);

        // Opsi untuk menampilkan Hari, Tanggal Bulan Tahun
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };

        return date.toLocaleDateString("id-ID", options);
      }
      /**
       * Memfilter data berdasarkan kartu yang diklik (Masuk/Keluar)
       */
      function filterByCard(type) {
        // 1. Reset input filter lainnya agar tidak tumpang tindih
        document.getElementById("searchInput").value = "";
        document.getElementById("dateStart").value = "";
        document.getElementById("dateEnd").value = "";

        // 2. Set nilai dropdown kategori sesuai kartu yang diklik
        document.getElementById("typeFilter").value = type;

        // 3. Jalankan logika pemfilteran data
        filterData();

        // 4. Scroll halus menuju tabel transaksi
        document.getElementById("transaksi").scrollIntoView({
          behavior: "smooth",
          block: "start",
        });

        // 5. Tampilkan panel filter jika sebelumnya tersembunyi
        const filterPanel = document.getElementById("filterPanel");
        if (
          type !== "" &&
          filterPanel &&
          filterPanel.classList.contains("hidden")
        ) {
          toggleFilter();
        }
      }
      function resetFilter() {
        // 1. Kosongkan semua input secara visual
        document.getElementById("searchInput").value = "";
        document.getElementById("typeFilter").value = "";
        document.getElementById("dateStart").value = "";
        document.getElementById("dateEnd").value = "";

        // 2. Kembalikan data filter ke seluruh data asli
        filteredData = [...allTransactions];

        // 3. Reset ke halaman pertama
        currentPage = 1;

        // 4. Update ringkasan filter (angka pemasukan/pengeluaran di atas tabel)
        updateFilterSummary();

        // 5. Render ulang tabel dan grafik
        renderTable();
        initChart(); // Mengembalikan grafik ke tampilan awal

        // 6. Tutup panel filter (opsional, agar tampilan lebih bersih)
        const filterPanel = document.getElementById("filterPanel");
        if (!filterPanel.classList.contains("hidden")) {
          toggleFilter();
        }

        // Notifikasi kecil (Opsional menggunakan SweetAlert)
        Swal.fire({
          toast: true,
          icon: "info",
          title: "Filter telah direset",
          position: "top-end",
          showConfirmButton: false,
          timer: 1500,
        });
      }
      function toggleFilter() {
        document.getElementById("filterPanel").classList.toggle("hidden");
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        const map = new maplibregl.Map({
          container: "map",
          style: "https://tiles.openfreemap.org/styles/bright",
          center: [112.66515501296685, -7.887241344040163],
          zoom: 16,
          bearing: 30,
          cooperativeGestures: true,
        });
        // Menambahkan kontrol navigasi (Zoom dan Kompas)
        map.addControl(
          new maplibregl.NavigationControl({
            showCompass: true, // Memastikan kompas muncul
            showZoom: false, // Memastikan tombol zoom muncul
            visualizePitch: true, // Mengubah ikon kompas saat peta dimiringkan
          }),
          "top-right",
        ); // Posisi kontrol di pojok kanan atas
        new maplibregl.Marker({ color: "#059669" })
          .setLngLat([112.66515501296685, -7.887241344040163])
          .addTo(map);
      });

      function formatPhoneNumber(phone) {
        if (!phone) return "";
        let clean = phone.toString().replace(/[^0-9]/g, "");

        // Jika dimulai 08..., ubah menjadi 628... agar seragam
        if (clean.startsWith("0")) {
          clean = "62" + clean.substring(1);
        }

        // Format menjadi: 62-8xxx-xxxx-xxxx
        if (clean.length >= 10) {
          return clean.replace(/(\d{2})(\d{4})(\d{4})(\d+)/, "$1-$2-$3-$4");
        }
        return clean;
      }

      async function copyToClipboard(text, message) {
        const cleanText = text.toString().replace(/[^0-9]/g, "");

        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(cleanText);
          } else {
            // Fallback untuk browser lama atau lingkungan non-secure
            let textArea = document.createElement("textarea");
            textArea.value = cleanText;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand("copy");
            textArea.remove();
          }

          Swal.fire({
            toast: true,
            icon: "success",
            title: message,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
          });
        } catch (err) {
          console.error("Gagal menyalin: ", err);
        }
      }

      const btn = document.getElementById("menu-btn");
      const menu = document.getElementById("mobile-menu");

      btn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });

      // Opsional: Tutup menu saat link diklik
      const links = menu.querySelectorAll("a");
      links.forEach((link) => {
        link.addEventListener("click", () => {
          menu.classList.add("hidden");
        });
      });
    </script>
  </body>
</html>
